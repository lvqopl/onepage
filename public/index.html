<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>我的标签页</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { Search, Plus, X, Edit2, Trash2, ExternalLink, Cloud, Sparkles, Download, Upload } = lucide;

    function StartPage() {
      const [bookmarks, setBookmarks] = useState([]);
      const [categories, setCategories] = useState(['全部', '开发', 'AI', '娱乐', '工具']);
      const [activeCategory, setActiveCategory] = useState('全部');
      const [searchEngine, setSearchEngine] = useState('google');
      const [searchQuery, setSearchQuery] = useState('');
      const [isAddingBookmark, setIsAddingBookmark] = useState(false);
      const [editingBookmark, setEditingBookmark] = useState(null);
      const [newBookmark, setNewBookmark] = useState({ title: '', url: '', category: '开发', customIcon: '' });
      const [currentTime, setCurrentTime] = useState(new Date());
      const [greeting, setGreeting] = useState('');
      const [saveMessage, setSaveMessage] = useState('');
      const fileInputRef = useRef(null);

      const searchEngines = {
        google: { name: 'Google', url: 'https://www.google.com/search?q=' },
        bing: { name: 'Bing', url: 'https://www.bing.com/search?q=' },
        baidu: { name: '百度', url: 'https://www.baidu.com/s?wd=' },
        duckduckgo: { name: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=' }
      };

      useEffect(() => {
        const timer = setInterval(() => setCurrentTime(new Date()), 1000);
        return () => clearInterval(timer);
      }, []);

      useEffect(() => {
        const hour = currentTime.getHours();
        if (hour < 12) setGreeting('早上好');
        else if (hour < 18) setGreeting('下午好');
        else setGreeting('晚上好');
      }, [currentTime]);

      useEffect(() => {
        loadBookmarks();
      }, []);

      const loadBookmarks = async () => {
        try {
          const response = await fetch('/api/bookmarks');
          if (response.ok) {
            const data = await response.json();
            setBookmarks(data.bookmarks || getDefaultBookmarks());
          } else {
            setBookmarks(getDefaultBookmarks());
          }
        } catch (error) {
          setBookmarks(getDefaultBookmarks());
        }
      };

      const getDefaultBookmarks = () => [
        { id: 1, title: 'GitHub', url: 'https://github.com', category: '开发', customIcon: '' },
        { id: 2, title: 'Stack Overflow', url: 'https://stackoverflow.com', category: '开发', customIcon: '' },
        { id: 3, title: 'MDN', url: 'https://developer.mozilla.org', category: '开发', customIcon: '' },
        { id: 4, title: 'ChatGPT', url: 'https://chat.openai.com', category: 'AI', customIcon: '' },
        { id: 5, title: 'Claude', url: 'https://claude.ai', category: 'AI', customIcon: '' },
        { id: 6, title: 'YouTube', url: 'https://youtube.com', category: '娱乐', customIcon: '' },
        { id: 7, title: 'Netflix', url: 'https://netflix.com', category: '娱乐', customIcon: '' },
        { id: 8, title: 'Gmail', url: 'https://mail.google.com', category: '工具', customIcon: '' },
      ];

      const saveBookmarks = async (newBookmarks) => {
        try {
          await fetch('/api/bookmarks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bookmarks: newBookmarks })
          });
          setSaveMessage('✓ 保存成功');
          setTimeout(() => setSaveMessage(''), 2000);
        } catch (error) {
          setSaveMessage('✗ 保存失败');
        }
      };

      const getFaviconUrl = (url) => {
        try {
          const domain = new URL(url).hostname;
          return `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
        } catch {
          return null;
        }
      };

      const handleSearch = (e) => {
        e.preventDefault();
        if (searchQuery.trim()) {
          const engine = searchEngines[searchEngine];
          window.open(`${engine.url}${encodeURIComponent(searchQuery)}`, '_blank');
          setSearchQuery('');
        }
      };

      const addBookmark = () => {
        if (newBookmark.title && newBookmark.url) {
          const bookmark = {
            id: Date.now(),
            ...newBookmark,
            category: newBookmark.category || '开发'
          };
          
          if (!categories.includes(bookmark.category)) {
            setCategories([...categories, bookmark.category]);
          }
          
          const updatedBookmarks = [...bookmarks, bookmark];
          setBookmarks(updatedBookmarks);
          saveBookmarks(updatedBookmarks);
          setNewBookmark({ title: '', url: '', category: '开发', customIcon: '' });
          setIsAddingBookmark(false);
        }
      };

      const deleteBookmark = (id) => {
        const updatedBookmarks = bookmarks.filter(b => b.id !== id);
        setBookmarks(updatedBookmarks);
        saveBookmarks(updatedBookmarks);
      };

      const startEdit = (bookmark) => {
        setEditingBookmark(bookmark);
        setNewBookmark({ 
          title: bookmark.title, 
          url: bookmark.url, 
          category: bookmark.category,
          customIcon: bookmark.customIcon || ''
        });
      };

      const saveEdit = () => {
        const updatedBookmarks = bookmarks.map(b => 
          b.id === editingBookmark.id ? { ...editingBookmark, ...newBookmark } : b
        );
        setBookmarks(updatedBookmarks);
        saveBookmarks(updatedBookmarks);
        setEditingBookmark(null);
        setNewBookmark({ title: '', url: '', category: '开发', customIcon: '' });
      };

      const exportBookmarks = () => {
        const dataStr = JSON.stringify(bookmarks, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `bookmarks_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        setSaveMessage('✓ 导出成功');
        setTimeout(() => setSaveMessage(''), 2000);
      };

      const importBookmarks = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) {
              setSaveMessage('✗ 文件格式错误');
              return;
            }

            const validBookmarks = imported.filter(b => b.title && b.url);
            if (validBookmarks.length === 0) {
              setSaveMessage('✗ 没有有效的书签数据');
              return;
            }

            const existingUrls = new Set(bookmarks.map(b => b.url));
            const newBookmarks = validBookmarks.filter(b => !existingUrls.has(b.url));
            
            if (newBookmarks.length === 0) {
              setSaveMessage('⚠ 所有书签已存在');
              setTimeout(() => setSaveMessage(''), 2000);
              return;
            }

            const bookmarksWithIds = newBookmarks.map(b => ({
              ...b,
              id: b.id || Date.now() + Math.random(),
              category: b.category || '未分类',
              customIcon: b.customIcon || ''
            }));

            const updatedBookmarks = [...bookmarks, ...bookmarksWithIds];
            setBookmarks(updatedBookmarks);
            saveBookmarks(updatedBookmarks);
            
            setSaveMessage(`✓ 成功导入 ${newBookmarks.length} 个书签`);
            setTimeout(() => setSaveMessage(''), 3000);
          } catch (error) {
            setSaveMessage('✗ 文件解析失败');
            setTimeout(() => setSaveMessage(''), 2000);
          }
        };
        
        reader.readAsText(file);
        event.target.value = '';
      };

      const filteredBookmarks = activeCategory === '全部' 
        ? bookmarks 
        : bookmarks.filter(b => b.category === activeCategory);

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
          <input
            type="file"
            ref={fileInputRef}
            onChange={importBookmarks}
            accept=".json"
            className="hidden"
          />

          <div className="fixed inset-0 overflow-hidden pointer-events-none">
            <div className="absolute top-20 left-10 w-72 h-72 bg-blue-200 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-pulse"></div>
            <div className="absolute top-40 right-10 w-72 h-72 bg-purple-200 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-pulse" style={{ animationDelay: '2s' }}></div>
            <div className="absolute -bottom-32 left-1/2 w-72 h-72 bg-pink-200 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-pulse" style={{ animationDelay: '4s' }}></div>
          </div>

          <div className="relative z-10 container mx-auto px-4 py-8 max-w-6xl">
            <div className="text-center mb-12 pt-8">
              <div className="flex items-center justify-center mb-4">
                <Cloud className="w-8 h-8 text-indigo-600 mr-2" />
                <h1 className="text-3xl font-bold text-gray-800">我的标签页</h1>
                <Sparkles className="w-6 h-6 text-yellow-500 ml-2" />
              </div>
              <p className="text-5xl font-light text-gray-700 mb-2">
                {currentTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}
              </p>
              <p className="text-xl text-gray-600">{greeting}，开始愉快的一天吧！</p>
              {saveMessage && (
                <p className={`mt-2 text-sm ${saveMessage.includes('成功') || saveMessage.includes('✓') ? 'text-green-600' : saveMessage.includes('⚠') ? 'text-yellow-600' : 'text-red-600'}`}>
                  {saveMessage}
                </p>
              )}
            </div>

            <div className="mb-8">
              <div className="max-w-2xl mx-auto">
                <div className="relative">
                  <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleSearch(e)}
                    placeholder={`使用 ${searchEngines[searchEngine].name} 搜索...`}
                    className="w-full pl-12 pr-32 py-4 rounded-2xl border-2 border-transparent bg-white/70 backdrop-blur-sm shadow-lg focus:outline-none focus:border-indigo-400 focus:bg-white transition-all text-lg"
                  />
                  <select
                    value={searchEngine}
                    onChange={(e) => setSearchEngine(e.target.value)}
                    className="absolute right-3 top-1/2 transform -translate-y-1/2 px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm focus:outline-none hover:bg-indigo-700 transition-colors cursor-pointer"
                  >
                    {Object.entries(searchEngines).map(([key, engine]) => (
                      <option key={key} value={key}>{engine.name}</option>
                    ))}
                  </select>
                </div>
              </div>
            </div>

            <div className="flex justify-center mb-6 gap-3 flex-wrap">
              <button
                onClick={() => setIsAddingBookmark(!isAddingBookmark)}
                className="flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105"
              >
                {isAddingBookmark ? <X className="w-5 h-5" /> : <Plus className="w-5 h-5" />}
                {isAddingBookmark ? '取消' : '添加书签'}
              </button>
              
              <button
                onClick={exportBookmarks}
                className="flex items-center gap-2 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105"
              >
                <Download className="w-5 h-5" />
                导出
              </button>
              
              <button
                onClick={() => fileInputRef.current?.click()}
                className="flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105"
              >
                <Upload className="w-5 h-5" />
                导入
              </button>
            </div>

            <div className="flex justify-center mb-8 gap-2 flex-wrap">
              {categories.map(category => (
                <button
                  key={category}
                  onClick={() => setActiveCategory(category)}
                  className={`px-4 py-2 rounded-lg transition-all ${
                    activeCategory === category
                      ? 'bg-indigo-600 text-white shadow-md'
                      : 'bg-white/70 text-gray-700 hover:bg-white hover:shadow-md'
                  }`}
                >
                  {category}
                </button>
              ))}
            </div>

            {(isAddingBookmark || editingBookmark) && (
              <div className="max-w-md mx-auto mb-8 p-6 bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl">
                <h3 className="text-xl font-semibold mb-4 text-gray-800">
                  {editingBookmark ? '编辑书签' : '新建书签'}
                </h3>
                <input
                  type="text"
                  placeholder="标题"
                  value={newBookmark.title}
                  onChange={(e) => setNewBookmark({ ...newBookmark, title: e.target.value })}
                  className="w-full px-4 py-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-400"
                />
                <input
                  type="url"
                  placeholder="URL (https://...)"
                  value={newBookmark.url}
                  onChange={(e) => setNewBookmark({ ...newBookmark, url: e.target.value })}
                  className="w-full px-4 py-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-400"
                />
                <input
                  type="text"
                  placeholder="分类"
                  value={newBookmark.category}
                  onChange={(e) => setNewBookmark({ ...newBookmark, category: e.target.value })}
                  className="w-full px-4 py-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-400"
                />
                <input
                  type="url"
                  placeholder="自定义图标 URL (可选)"
                  value={newBookmark.customIcon}
                  onChange={(e) => setNewBookmark({ ...newBookmark, customIcon: e.target.value })}
                  className="w-full px-4 py-2 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-400"
                />
                <div className="flex gap-3">
                  <button
                    onClick={editingBookmark ? saveEdit : addBookmark}
                    className="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors"
                  >
                    {editingBookmark ? '保存' : '添加'}
                  </button>
                  <button
                    onClick={() => {
                      setIsAddingBookmark(false);
                      setEditingBookmark(null);
                      setNewBookmark({ title: '', url: '', category: '开发', customIcon: '' });
                    }}
                    className="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors"
                  >
                    取消
                  </button>
                </div>
              </div>
            )}

            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              {filteredBookmarks.map((bookmark) => (
                <div
                  key={bookmark.id}
                  className="group relative bg-white/70 backdrop-blur-sm rounded-xl p-5 shadow-md hover:shadow-xl transition-all transform hover:-translate-y-1"
                >
                  <a
                    href={bookmark.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="block"
                  >
                    <div className="flex items-center gap-3 mb-2">
                      {bookmark.customIcon ? (
                        <img 
                          src={bookmark.customIcon} 
                          alt={bookmark.title}
                          className="w-10 h-10 rounded-lg object-cover"
                          onError={(e) => {
                            e.target.style.display = 'none';
                            e.target.nextSibling.style.display = 'flex';
                          }}
                        />
                      ) : null}
                      {!bookmark.customIcon && getFaviconUrl(bookmark.url) ? (
                        <img 
                          src={getFaviconUrl(bookmark.url)} 
                          alt={bookmark.title}
                          className="w-10 h-10 rounded-lg"
                          onError={(e) => {
                            e.target.style.display = 'none';
                            e.target.nextSibling.style.display = 'flex';
                          }}
                        />
                      ) : null}
                      <div 
                        className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-md"
                        style={{ display: bookmark.customIcon || getFaviconUrl(bookmark.url) ? 'none' : 'flex' }}
                      >
                        {bookmark.title[0]}
                      </div>
                      <ExternalLink className="w-4 h-4 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity" />
                    </div>
                    <h3 className="font-medium text-gray-800 truncate">{bookmark.title}</h3>
                    <p className="text-xs text-gray-500 truncate mt-1">{bookmark.url}</p>
                  </a>
                  <div className="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button
                      onClick={() => startEdit(bookmark)}
                      className="p-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
                    >
                      <Edit2 className="w-3 h-3" />
                    </button>
                    <button
                      onClick={() => deleteBookmark(bookmark.id)}
                      className="p-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
                    >
                      <Trash2 className="w-3 h-3" />
                    </button>
                  </div>
                </div>
              ))}
            </div>

            {filteredBookmarks.length === 0 && (
              <div className="text-center py-20">
                <p className="text-gray-500 text-lg">
                  {activeCategory === '全部' ? '还没有书签，点击上方按钮添加吧！' : `"${activeCategory}" 分类下暂无书签`}
                </p>
              </div>
            )}

            <div className="mt-16 text-center text-sm text-gray-500">
              <p>Powered by Cloudflare Workers + KV | Made with ❤️</p>
            </div>
          </div>
        </div>
      );
    }

    // 关键修复：使用 React 18 的 createRoot API
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<StartPage />);
  </script>
</body>
</html>
